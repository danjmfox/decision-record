---
id: DR--20251102--meta--build-artifacts-strategy
dateCreated: "2025-11-02"
version: "1.0"
status: accepted
changeType: creation
domain: meta
slug: build-artifacts-strategy
changelog:
  - date: "2025-11-02"
    note: Initial creation
  - date: "2025-11-02"
    note: Marked as accepted
lastEdited: "2025-11-02"
dateAccepted: "2025-11-02"
---

# DR--20251102--meta--build-artifacts-strategy

## üß≠ Context

We previously committed compiled JavaScript under `dist/`, which led to stale binaries (for example, `dist/cli/index.js` no longer matched the expanded Commander command set in `src/cli/index.ts`). Keeping build artefacts in git creates noisy diffs, makes reviews harder, and risks shipping outdated behaviour when releases rely on those files.

For public distribution we need a deterministic way to produce the CLI without version-controlling the compiled output.

## ‚öñÔ∏è Options Considered

| Option                           | Description                                                    | Outcome  | Rationale                                                                                         |
| -------------------------------- | -------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------- |
| Commit `dist/` (status quo)      | Continue tracking compiled artefacts in git                    | Rejected | Encourages drift between source and binary, bloats diffs, complicates review hygiene.             |
| Build-on-install                 | Run `tsc` in a `postinstall` hook                              | Rejected | Fails for global installs without TypeScript, slows consumers, breaks offline usage.              |
| Ignore `dist/`, build on package | Generate artefacts at pack/publish time via npm lifecycle hook | Accepted | Keeps repo clean while ensuring published tarballs always contain the compiled CLI and bin entry. |

## üß† Decision

- Stop committing `dist/` and add it to `.gitignore`.
- Configure `package.json` with:
  - A `prepack` script that runs `npm run build` so `npm pack`/`npm publish` always produce fresh artefacts.
  - A `files` allowlist (or `.npmignore`) so the packed tarball includes `dist/` plus key docs.
- Keep the `bin.drctl` pointer at `dist/cli/index.js`, relying on the build output generated by the `prepack` hook.
- Document the workflow (README/AGENTS) so contributors run `npm run build` or `npm pack` when vetting releases.

## ü™∂ Principles

- **Reasoning is code** ‚Äì the build policy lives as a DR and is enforced through scripts and ignore rules.
- **Trust through transparency** ‚Äì npm lifecycle hooks make the packaging process inspectable (`npm pack` mirrors publish).
- **Progressive disclosure** ‚Äì default `npm install -g drctl` works without extra steps; contributors opt into build tooling only when packaging.

## üîÑ Lifecycle

- Status: `accepted` (implemented alongside ignore rules and packaging metadata).

## üß© Reasoning

Using `prepack` avoids surprises: whether we run `npm pack` locally or via CI, the TypeScript compiler runs first, producing the expected `dist/` output. By allowing `dist/` only in published tarballs we keep the git history readable. Consumers installing from npm still receive the compiled CLI because npm publishes the tarball, not the git repository.

We rejected `postinstall` because it burdens every install with TypeScript as a build-time dependency and fails in restricted environments. Treating the artefact generation as part of publish-time responsibilities keeps the CLI easily consumable while preserving repository clarity.

## üîÑ Next Actions

- Update `.gitignore`, `package.json`, and documentation to reflect this policy.
- Add a release checklist referencing `npm pack` for local verification.
- Consider a future CI job that archives the `npm pack` output for traceability.

## üß† Confidence

High ‚Äì npm lifecycle hooks are well understood, and ignoring `dist/` is a common practice in TypeScript CLIs. Manual verification via `npm pack` keeps the flow observable.

## üßæ Changelog

- 2025-11-02 ‚Äî Decision recorded and accepted.
